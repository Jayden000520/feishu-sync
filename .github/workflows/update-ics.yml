name: Build & Publish Feishu ICS

on:
  workflow_dispatch:         # 手动触发
  schedule:
    - cron: '*/30 * * * *'   # 每 30 分钟运行一次

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install PHP
        run: |
          sudo apt-get update
          sudo apt-get install -y php-cli php-curl

      - name: Create config file
        run: |
          cat > caldav2ics.yaml <<EOF
          calendars:
            - url: "${{ secrets.CAL_URL }}${{ secrets.CAL_PATH }}"
              user: "${{ secrets.CAL_USER }}"
              pass: "${{ secrets.CAL_PASS }}"
              file: "feishu.ics"
          EOF

      - name: Run caldav2ics
        run: php caldav2ics.php

      - name: Commit & push
        uses: EndBug/add-and-commit@v9
        with:
          add: feishu.ics
          message: 'chore: update Feishu ICS'
