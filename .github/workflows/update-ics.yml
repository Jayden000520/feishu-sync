name: Build & Publish Feishu ICS

on:
  workflow_dispatch:         # æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '*/30 * * * *'   # æ¯ 30 åˆ†é’Ÿè¿è¡Œä¸€æ¬¡

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install PHP
        run: |
          sudo apt-get update
          sudo apt-get install -y php-cli php-curl
      - name: Discover CAL_PATH   # ðŸ‘ˆ ä¸´æ—¶æŽ¢è·¯
        id: discover
        run: |
          echo "ðŸ” Probing Feishu CalDAV root ..."
          curl -u "${{ secrets.CAL_USER }}:${{ secrets.CAL_PASS }}" \
               -X PROPFIND -H "Depth: 1" -H "Content-Type: application/xml" \
               https://caldav.feishu.cn/calendars/ 2>/dev/null | \
               grep -o '/calendars/[^/]\+/' | head -n 1 | tee calpath.txt
      - name: Create config file
        run: |
          cat > caldav2ics.yaml <<EOF
          calendars:
            - url: "${{ secrets.CAL_URL }}${{ secrets.CAL_PATH }}"
              user: "${{ secrets.CAL_USER }}"
              pass: "${{ secrets.CAL_PASS }}"
              file: "feishu.ics"
          EOF

      - name: Run caldav2ics
        run: php caldav2ics.php

      - name: Commit & push
        uses: EndBug/add-and-commit@v9
        with:
          add: feishu.ics
          message: 'chore: update Feishu ICS'
