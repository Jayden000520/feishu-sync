name: Build & Publish Feishu ICS

on:
  workflow_dispatch:         # æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '*/30 * * * *'   # æ¯ 30 åˆ†é’Ÿè¿è¡Œä¸€æ¬¡

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install PHP
        run: |
          sudo apt-get update
          sudo apt-get install -y php-cli php-curl
      - name: Discover CAL_PATH   # ä¸´æ—¶æŽ¢è·¯ï¼ˆå«çŠ¶æ€ç ï¼‰
        run: |
          echo "ðŸ” Probing Feishu CalDAV root ..."
          curl -u "${{ secrets.CAL_USER }}:${{ secrets.CAL_PASS }}" \
               -I https://caldav.feishu.cn/calendars/ || true   # -I åªå–å“åº”å¤´
          echo "â€”â€” æ­£æ–‡é¢„è§ˆ â€”â€”"
          curl -u "${{ secrets.CAL_USER }}:${{ secrets.CAL_PASS }}" \
               -X PROPFIND -H "Depth: 1" -H "Content-Type: application/xml" \
               https://caldav.feishu.cn/calendars/ \
               | head -n 40
      - name: Create config file
        run: |
          cat > caldav2ics.yaml <<EOF
          calendars:
            - Name: Feishu
              Url: "${{ secrets.CAL_URL }}${{ secrets.CAL_PATH }}"
              User: "${{ secrets.CAL_USER }}"
              Pass: "${{ secrets.CAL_PASS }}"
              File: "feishu.ics"
          EOF


      - name: Run caldav2ics
        run: php caldav2ics.php

      - name: Commit & push
        uses: EndBug/add-and-commit@v9
        with:
          add: feishu.ics
          message: 'chore: update Feishu ICS'
